<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS 录入系统</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:8px;background:#f5f6f8}
h1{font-size:22px;text-align:center;margin-bottom:16px}
section{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
h3{margin-top:0;margin-bottom:8px;font-size:18px}
label{display:block;margin:6px 0;font-weight:600}
input,select,button{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;font-size:16px}
button{background:#1976d2;color:#fff;border:none;cursor:pointer;transition:background 0.2s}
button:hover{background:#1565c0}
button.small{width:48%;display:inline-block;margin-right:4%}
.quick-btns{display:flex;gap:4px;margin-top:6px}
.quick-btns button{flex:1;margin-right:0}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid #e3e3e3;padding:8px;text-align:center;font-size:14px}
@media(max-width:600px){
    button.small{width:100%;margin-bottom:6px}
    .quick-btns{flex-direction:column}
}
</style>
</head>
<body>
<h1>POS 录入系统</h1>

<!-- 销售平台管理 -->
<section id="platform-section">
  <h3>销售平台管理</h3>
  <div id="platform-list">加载中...</div>
  <label>新增销售平台</label>
  <input id="new-platform-name" placeholder="输入平台名称">
  <button onclick="addPlatform()">新增平台</button>
</section>

<!-- 产品上架 -->
<section id="product-section">
  <h3>产品上架</h3>
  <label>产品名称</label>
  <input id="new-product-name" placeholder="输入产品名称">
  <label>价格</label>
  <input id="new-product-price" type="number" step="0.01" placeholder="输入价格">
  <button onclick="addProduct()">上架产品</button>
</section>

<!-- 新订单录入 -->
<section id="order-section">
  <h3>新订单录入</h3>
  <label>选择销售平台</label>
  <select id="order-platform"><option value=''>请选择平台</option></select>
  <div id="order-rows"></div>
  <button onclick="addOrderRow()" class="small">+ 添加产品</button>
  <button onclick="saveOrder()" class="small">保存订单</button>
</section>

<!-- 当周订单汇总 -->
<section id="week-section">
  <h3>当周订单汇总（按产品）</h3>
  <div id="week-summary">加载中...</div>
</section>

<!-- 当天订单明细 -->
<section id="today-section">
  <h3>当天订单明细</h3>
  <div id="today-summary"></div>
  <div style="margin-top:6px">
    <button onclick="exportToday()">导出当日订单（CSV）</button>
  </div>
  <div id="today-orders"></div>
</section>

<!-- 历史订单导出 -->
<section id="history-section">
  <h3>历史订单导出</h3>
  <label>选择日期范围</label>
  <input type="date" id="history-start">
  <input type="date" id="history-end">
  <div class="quick-btns">
    <button onclick="setHistoryQuick('today')">今天</button>
    <button onclick="setHistoryQuick('yesterday')">昨天</button>
    <button onclick="setHistoryQuick('week')">本周</button>
    <button onclick="setHistoryQuick('month')">本月</button>
  </div>
  <button onclick="exportHistory()" style="margin-top:6px">导出选定时间范围订单（CSV）</button>
</section>

<script>
async function api(path, opts){
    const r = await fetch(path, opts||{});
    if(!r.ok){
        const t = await r.text();
        console.error('API error', path, t);
        throw new Error(t);
    }
    return r.json().catch(()=>null);
}

// 加载销售平台
async function loadPlatforms(){
    const list = await api('/api/platforms');
    document.getElementById('platform-list').innerHTML = list.map(p=>`<div>${p.id}. ${p.name}</div>`).join('')||'<div>暂无平台</div>';
    const sel=document.getElementById('order-platform');
    sel.innerHTML='<option value="">请选择平台</option>';
    list.forEach(p=>{
        const o=document.createElement('option');
        o.value=p.id;
        o.text=p.name;
        sel.appendChild(o);
    });
}

// 加载产品
async function loadProducts(){
    const list = await api('/api/products');
    window.PRODUCTS = list;
}

// 新增销售平台
async function addPlatform(){
    const name=document.getElementById('new-platform-name').value.trim();
    if(!name){alert('请输入平台名称');return;}
    await api('/api/platforms',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name})
    });
    document.getElementById('new-platform-name').value='';
    await loadPlatforms();
}

// 新增产品
async function addProduct(){
    const name=document.getElementById('new-product-name').value.trim();
    const price=parseFloat(document.getElementById('new-product-price').value);
    if(!name||isNaN(price)){alert('请输入产品名和价格');return;}
    await api('/api/products',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name,price})
    });
    document.getElementById('new-product-name').value='';
    document.getElementById('new-product-price').value='';
    await loadProducts();
}

// 添加订单行
function addOrderRow(){
    const rows=document.getElementById('order-rows');
    const div=document.createElement('div');
    div.style.borderTop='1px solid #eee';
    div.style.padding='8px 0';

    const sel=document.createElement('select');
    sel.innerHTML='<option value="">请选择产品</option>' + (window.PRODUCTS||[]).map(p=>`<option value="${p.id}" data-price="${p.price}">${p.name}</option>`).join('');
    sel.onchange=function(){ priceInput.value = sel.selectedOptions[0].dataset.price || ''; };
    div.appendChild(sel);

    const priceInput=document.createElement('input');
    priceInput.placeholder='单价';
    priceInput.readOnly=true;
    priceInput.style.marginTop='6px';
    div.appendChild(priceInput);

    const qtyInput=document.createElement('input');
    qtyInput.type='number';
    qtyInput.value=1;
    qtyInput.placeholder='数量';
    qtyInput.style.marginTop='6px';
    div.appendChild(qtyInput);

    const discInput=document.createElement('input');
    discInput.type='number';
    discInput.value=0;
    discInput.placeholder='优惠券金额（可为负）';
    discInput.style.marginTop='6px';
    div.appendChild(discInput);

    const btn=document.createElement('button');
    btn.textContent='删除此行';
    btn.style.marginTop='6px';
    btn.onclick=()=>div.remove();
    div.appendChild(btn);

    rows.appendChild(div);
}

// 保存订单
async function saveOrder(){
    const platform_id=parseInt(document.getElementById('order-platform').value);
    if(isNaN(platform_id)){alert('请选择销售平台');return;}
    const rows=document.querySelectorAll('#order-rows > div');
    if(rows.length===0){alert('请添加至少一项产品');return;}
    const items=[];
    for(const r of rows){
        const sel=r.querySelector('select');
        const pid=parseInt(sel.value);
        if(!pid) continue;
        const pname=sel.selectedOptions[0].text;
        const price=parseFloat(r.querySelector('input[placeholder="单价"]').value || sel.selectedOptions[0].dataset.price || 0);
        const qty=parseInt(r.querySelector('input[placeholder="数量"]').value || 1);
        const discount=parseFloat(r.querySelector('input[placeholder^="优惠券"]').value || 0);
        items.push({product_id:pid, product_name:pname, price, quantity:qty, discount});
    }
    if(!items.length){alert('订单中无有效产品');return;}
    await api('/api/orders',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({items, platform_id})
    });
    document.getElementById('order-rows').innerHTML='';
    alert('订单已保存');
    await refreshToday();
    await refreshWeek();
}

// 当周订单汇总
async function refreshWeek(){
    const data = await api('/api/orders/week-summary');
    const c=document.getElementById('week-summary');
    if(!data||!data.length){ c.innerHTML='<div>本周无订单</div>'; return;}
    let html='<table class="table"><thead><tr><th>产品</th><th>本周销量</th><th>本周营收</th></tr></thead><tbody>';
    data.forEach(r=> html += `<tr><td>${r.product_name}</td><td>${r.total_qty}</td><td>${Number(r.total_amount).toFixed(2)}</td></tr>`);
    html += '</tbody></table>';
    c.innerHTML=html;
}

// 当天订单明细
async function refreshToday(){
    const data = await api('/api/orders/today');
    const sum=document.getElementById('today-summary');
    if(!data){ sum.innerHTML=''; return;}
    sum.innerHTML = `<div>订单数：${data.orderCount}，产品总数：${data.totalQty}，营业额：${Number(data.totalAmount).toFixed(2)}</div>`;

    let html = '<h4>按产品汇总</h4><table class="table"><thead><tr><th>产品</th><th>销量</th><th>营收</th></tr></thead><tbody>';
    (data.productSummary||[]).forEach(p=> html += `<tr><td>${p.product_name}</td><td>${p.qty}</td><td>${Number(p.amount).toFixed(2)}</td></tr>`);
    html += '</tbody></table>';

    html += '<h4>按平台+产品汇总</h4><table class="table"><thead><tr><th>销售平台</th><th>产品</th><th>销量</th><th>营收</th></tr></thead><tbody>';
    (data.platformProductSummary||[]).forEach(p=> html += `<tr><td>${p.platform}</td><td>${p.product_name}</td><td>${p.qty}</td><td>${Number(p.amount).toFixed(2)}</td></tr>`);
    html += '</tbody></table>';

    html += '<h4>订单明细</h4><table class="table"><thead><tr><th>订单ID</th><th>订单时间</th><th>产品名称</th><th>单价</th><th>数量</th><th>优惠券金额</th><th>小计</th><th>销售平台</th></tr></thead><tbody>';
    (data.orders||[]).forEach(o => {
        (o.items||[]).forEach(it => {
            html += `<tr><td>${o.id}</td><td>${o.created_at}</td><td>${it.product_name}</td><td>${Number(it.price).toFixed(2)}</td><td>${it.quantity}</td><td>${Number(it.discount).toFixed(2)}</td><td>${Number(it.subtotal).toFixed(2)}</td><td>${it.platform_name || '未指定'}</td></tr>`;
        });
    });
    html += '</tbody></table>';
    document.getElementById('today-orders').innerHTML = html;
}

// 导出当天订单
function exportToday(){ window.location.href = '/api/orders/today/export'; }

// 设置历史订单快捷日期
function setHistoryQuick(range){
    const startInput = document.getElementById('history-start');
    const endInput = document.getElementById('history-end');
    const today = new Date();
    let start,end;

    switch(range){
        case 'today':
            start=end=today; break;
        case 'yesterday':
            start=end=new Date(today.getTime()-86400000); break;
        case 'week':
            const day=today.getDay();
            start=new Date(today.getTime() - day*86400000);
            end=today; break;
        case 'month':
            start=new Date(today.getFullYear(),today.getMonth(),1);
            end=today; break;
    }

    startInput.value = start.toISOString().split('T')[0];
    endInput.value = end.toISOString().split('T')[0];
}

// 导出历史订单
function exportHistory(){
    const start = document.getElementById('history-start').value;
    const end = document.getElementById('history-end').value;
    if(!start || !end){alert('请选择开始和结束日期'); return;}
    if(start > end){alert('结束日期不能早于开始日期'); return;}
    window.location.href = `/api/orders/export?start=${start}&end=${end}`;
}

// 页面初始化
async function init(){
    await loadPlatforms();
    await loadProducts();
    await refreshWeek();
    await refreshToday();
}
init();
</script>
</body>
</html>
