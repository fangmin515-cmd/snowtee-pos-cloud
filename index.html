
<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Snowtee POS 系统</title>
<style>
body { font-family: Arial; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
input, select { padding: 4px; }
button { padding: 6px 10px; margin: 2px; }
</style>
</head>
<body>
<h1>Snowtee POS 系统</h1>

<h3>产品上架</h3>
产品名: <input id="new-product-name">
价格: <input id="new-product-price" type="number" step="0.01">
<button onclick="addProduct()">上架</button>

<h3>新订单录入</h3>
<table id="order-table">
<thead>
<tr><th>产品</th><th>单价</th><th>数量</th><th>优惠金额</th><th>操作</th></tr>
</thead>
<tbody></tbody>
</table>
<button onclick="addOrderRow()">+ 添加产品</button>
<br><br>
<button onclick="saveOrder()">保存订单</button>

<h3>当日统计</h3>
<div id="summary"></div>

<h3>各产品销量及金额</h3>
<div id="product-summary"></div>

<h3>当日订单明细</h3>
<div id="orders"></div>

<script>
let products = [];

function loadProducts() {
    fetch('/api/products')
    .then(r => r.json())
    .then(data => { products = data; });
}

function addProduct() {
    const name = document.getElementById('new-product-name').value.trim();
    const price = parseFloat(document.getElementById('new-product-price').value);
    if(!name || isNaN(price)){ alert('请填写产品名和价格'); return; }
    fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({name, price})
    })
    .then(r => r.json())
    .then(d => {
        alert('产品已上架');
        document.getElementById('new-product-name').value = '';
        document.getElementById('new-product-price').value = '';
        loadProducts();
    });
}

function addOrderRow(){
    const tbody = document.querySelector('#order-table tbody');
    const row = document.createElement('tr');

    const tdSelect = document.createElement('td');
    const select = document.createElement('select');
    select.onchange = () => updatePrice(select);
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '请选择';
    select.appendChild(defaultOption);
    products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        opt.dataset.price = p.price;
        select.appendChild(opt);
    });
    tdSelect.appendChild(select);
    row.appendChild(tdSelect);

    const tdPrice = document.createElement('td');
    const inputPrice = document.createElement('input');
    inputPrice.type = 'number';
    inputPrice.step = '0.01';
    inputPrice.readOnly = true;
    tdPrice.appendChild(inputPrice);
    row.appendChild(tdPrice);

    const tdQty = document.createElement('td');
    const inputQty = document.createElement('input');
    inputQty.type = 'number';
    inputQty.value = 1;
    tdQty.appendChild(inputQty);
    row.appendChild(tdQty);

    const tdDiscount = document.createElement('td');
    const inputDiscount = document.createElement('input');
    inputDiscount.type = 'number';
    inputDiscount.step = '0.01';
    inputDiscount.value = 0;
    tdDiscount.appendChild(inputDiscount);
    row.appendChild(tdDiscount);

    const tdRemove = document.createElement('td');
    const btnRemove = document.createElement('button');
    btnRemove.textContent = '删除';
    btnRemove.onclick = () => row.remove();
    tdRemove.appendChild(btnRemove);
    row.appendChild(tdRemove);

    tbody.appendChild(row);
}

function updatePrice(select){
    const priceInput = select.parentElement.nextElementSibling.firstElementChild;
    const option = select.selectedOptions[0];
    priceInput.value = option && option.dataset.price ? option.dataset.price : '';
}

function saveOrder(){
    const rows = document.querySelectorAll('#order-table tbody tr');
    if(rows.length === 0){ alert('请添加产品'); return; }
    const items = [];
    rows.forEach(r => {
        const sel = r.querySelector('select');
        const prodId = parseInt(sel.value);
        if(!prodId) return;
        const prodName = sel.selectedOptions[0].text;
        const price = parseFloat(r.querySelector('td:nth-child(2) input').value);
        const qty = parseInt(r.querySelector('td:nth-child(3) input').value);
        const discount = parseFloat(r.querySelector('td:nth-child(4) input').value);
        items.push({product_id: prodId, product_name: prodName, price, quantity: qty, discount});
    });
    fetch('/api/orders',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({items})
    })
    .then(r => r.json())
    .then(d => {
        alert('订单已保存');
        document.querySelector('#order-table tbody').innerHTML = '';
        loadToday();
    });
}

function loadToday(){
    fetch('/api/orders/today')
    .then(r => r.json())
    .then(data => {
        document.getElementById('summary').innerHTML = `订单数：${data.orderCount} | 总件数：${data.totalQty} | 营业额：${data.totalAmount.toFixed(2)}`;
        let ps = '<table><tr><th>产品</th><th>销量</th><th>销售额</th></tr>';
        data.products.forEach(p => { ps += `<tr><td>${p.product_name}</td><td>${p.total_qty}</td><td>${p.total_amount.toFixed(2)}</td></tr>`; });
        ps += '</table>'; document.getElementById('product-summary').innerHTML = ps;
        let html = '<table><tr><th>订单ID</th><th>时间</th><th>产品</th><th>数量</th><th>单价</th><th>优惠</th><th>小计</th></tr>';
        data.orders.forEach(o => { o.items.forEach(i => { html += `<tr><td>${o.id}</td><td>${o.created_at}</td><td>${i.product_name}</td><td>${i.quantity}</td><td>${i.price}</td><td>${i.discount}</td><td>${i.subtotal.toFixed(2)}</td></tr>`; }); });
        html += '</table>'; document.getElementById('orders').innerHTML = html;
    });
}

loadProducts();
loadToday();
</script>
</body>
</html>
